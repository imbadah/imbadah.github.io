<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>الأدوات – PdfSwift</title>

  <!-- خطوط + أيقونات -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- pdf-lib – آخر إصدار مستقر معروف (1.17.1) -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <!-- أسلوبك الرئيسي -->
  <link rel="stylesheet" href="style.css">

  <style>
    /* تعديلات إضافية خاصة بصفحة الأدوات */
    .tools-page { padding: 3rem 1rem; }
    .tool-selector { gap: 1.5rem; }
    .tool-btn {
      background: #1e40af;
      color: white;
      border: none;
      padding: 1.5rem 1rem;
      border-radius: 12px;
      font-size: 1.25rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 6px 15px rgba(30,64,175,0.2);
    }
    .tool-btn:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(30,64,175,0.3); }
    .dark-theme .tool-btn { background: #3b82f6; box-shadow: 0 6px 15px rgba(59,130,246,0.3); }

    .tool-section {
      background: white;
      border-radius: 16px;
      padding: 2.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: 2rem auto;
    }
    .dark-theme .tool-section { background: #1e293b; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

    .tool-section h2 { margin-bottom: 1.8rem; color: #1e40af; }
    .dark-theme .tool-section h2 { color: #60a5fa; }

    input[type="file"], input[type="text"], select {
      width: 100%;
      padding: 0.9rem;
      margin: 1rem 0;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      font-size: 1.1rem;
    }
    .dark-theme input, .dark-theme select {
      background: #334155;
      color: #e2e8f0;
      border-color: #475569;
    }

    button.action-btn {
      background: #1e40af;
      color: white;
      border: none;
      padding: 1rem 2.5rem;
      border-radius: 50px;
      font-size: 1.15rem;
      cursor: pointer;
      margin-top: 1.5rem;
      transition: all 0.3s;
    }
    button.action-btn:hover { background: #1e3a8a; transform: translateY(-2px); }
    .dark-theme button.action-btn { background: #3b82f6; }
    .dark-theme button.action-btn:hover { background: #2563eb; }

    .status { margin-top: 1.5rem; font-weight: bold; min-height: 1.5rem; }
    .success { color: #16a34a; }
    .error   { color: #dc2626; }
  </style>
</head>
<body class="light-theme">

  <!-- header الخاص بك – استبدله بما عندك -->
  <header class="header">
    <div class="container">
      <a href="index.html" class="logo">Pdf<span>Swift</span></a>
      <nav class="nav">
        <a href="index.html">الرئيسية</a>
        <a href="tools.html" class="active">الأدوات</a>
        <a href="about.html">عن الموقع</a>
        <a href="privacy.html">سياسة الخصوصية</a>
      </nav>
      <button id="themeToggle" class="theme-btn" aria-label="تبديل الوضع">
        <i class="fa-solid fa-moon-stars"></i>
      </button>
    </div>
  </header>

  <main class="container tools-page">

    <h1 class="section-title">أدوات PDF في المتصفح</h1>
    <p style="text-align:center; margin-bottom: 3rem; opacity:0.9;">
      اختر أداة – كل العمليات تتم محليًا بدون رفع الملفات
    </p>

    <!-- قائمة الأدوات -->
    <div class="grid tool-selector">
      <button class="tool-btn" data-tool="merge">دمج ملفات PDF</button>
      <button class="tool-btn" data-tool="split">تقسيم / استخراج صفحات</button>
      <button class="tool-btn" data-tool="rotate">تدوير الصفحات</button>
      <button class="tool-btn" data-tool="watermark">إضافة علامة مائية نصية</button>
    </div>

    <!-- ─── أقسام الأدوات ─── -->

    <section id="tool-merge" class="tool-section" style="display:none;">
      <h2>دمج ملفات PDF</h2>
      <input type="file" id="merge-files" multiple accept=".pdf" />
      <button id="btn-merge" class="action-btn">دمج الملفات الآن</button>
      <div id="merge-status" class="status"></div>
    </section>

    <section id="tool-split" class="tool-section" style="display:none;">
      <h2>تقسيم أو استخراج صفحات</h2>
      <input type="file" id="split-file" accept=".pdf" />
      <input type="text" id="split-ranges" placeholder="نطاقات الصفحات: 1-3,5,8-10" />
      <button id="btn-split" class="action-btn">استخراج الصفحات</button>
      <div id="split-status" class="status"></div>
    </section>

    <section id="tool-rotate" class="tool-section" style="display:none;">
      <h2>تدوير صفحات الملف</h2>
      <input type="file" id="rotate-file" accept=".pdf" />
      <select id="rotate-degree">
        <option value="90">90° يمين</option>
        <option value="180">180°</option>
        <option value="270">90° يسار</option>
      </select>
      <button id="btn-rotate" class="action-btn">تدوير الملف</button>
      <div id="rotate-status" class="status"></div>
    </section>

    <section id="tool-watermark" class="tool-section" style="display:none;">
      <h2>إضافة علامة مائية نصية</h2>
      <input type="file" id="watermark-file" accept=".pdf" />
      <input type="text" id="watermark-text" placeholder="النص (مثال: سري جداً)" />
      <button id="btn-watermark" class="action-btn">إضافة العلامة</button>
      <div id="watermark-status" class="status"></div>
    </section>

    <!-- زر العودة -->
    <button id="back-to-tools" class="action-btn" style="display:none; margin: 3rem auto;">
      ← العودة إلى قائمة الأدوات
    </button>

  </main>

  <footer class="footer">
    <div class="container">
      <p>© 2026 PdfSwift – جميع الحقوق محفوظة</p>
    </div>
  </footer>

  <!-- theme.js الخاص بك -->
  <script src="theme.js"></script>

  <!-- منطق الأدوات -->
  <script>
    const { PDFDocument, rgb, degrees } = PDFLib;

    // تبديل بين القائمة والأدوات
    document.querySelectorAll('.tool-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tool = btn.dataset.tool;
        document.querySelectorAll('.tool-selector, .section-title, main > p').forEach(el => el.style.display = 'none');
        document.getElementById(`tool-${tool}`).style.display = 'block';
        document.getElementById('back-to-tools').style.display = 'block';
      });
    });

    document.getElementById('back-to-tools').addEventListener('click', () => {
      document.querySelectorAll('.tool-section').forEach(el => el.style.display = 'none');
      document.getElementById('back-to-tools').style.display = 'none';
      document.querySelector('.tool-selector').style.display = 'grid';
      document.querySelector('.section-title').style.display = 'block';
      document.querySelector('main > p').style.display = 'block';
    });

    // دالة تحميل الملف
    function downloadBlob(bytes, fileName) {
      const blob = new Blob([bytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // 1. دمج
    document.getElementById('btn-merge')?.addEventListener('click', async (e) => {
      const files = document.getElementById('merge-files').files;
      const status = document.getElementById('merge-status');
      if (files.length < 2) return status.textContent = 'اختر ملفين على الأقل';

      status.className = 'status';
      status.textContent = 'جاري الدمج...';

      try {
        const merged = await PDFDocument.create();
        for (const file of files) {
          const buf = await file.arrayBuffer();
          const src = await PDFDocument.load(buf);
          const pages = await merged.copyPages(src, src.getPageIndices());
          pages.forEach(p => merged.addPage(p));
        }
        const pdfBytes = await merged.save();
        downloadBlob(pdfBytes, 'merged-document.pdf');
        status.className = 'status success';
        status.textContent = 'تم الدمج بنجاح!';
      } catch (err) {
        status.className = 'status error';
        status.textContent = 'خطأ: ' + err.message;
      }
    });

    // 2. استخراج / تقسيم
    document.getElementById('btn-split')?.addEventListener('click', async (e) => {
      const file = document.getElementById('split-file').files[0];
      const rangesStr = document.getElementById('split-ranges').value.trim();
      const status = document.getElementById('split-status');

      if (!file) return status.textContent = 'اختر ملف PDF أولاً';
      if (!rangesStr) return status.textContent = 'أدخل نطاقات الصفحات';

      status.className = 'status';
      status.textContent = 'جاري المعالجة...';

      try {
        const buf = await file.arrayBuffer();
        const pdf = await PDFDocument.load(buf);
        const total = pdf.getPageCount();

        const indices = rangesStr.split(',')
          .map(r => r.trim())
          .flatMap(r => {
            if (r.includes('-')) {
              const [s, e] = r.split('-').map(Number);
              return Array.from({length: e - s + 1}, (_, i) => s + i - 1);
            }
            return [Number(r) - 1];
          })
          .filter(i => !isNaN(i) && i >= 0 && i < total);

        if (indices.length === 0) throw new Error('لا توجد صفحات صالحة');

        const newPdf = await PDFDocument.create();
        const copied = await newPdf.copyPages(pdf, indices);
        copied.forEach(p => newPdf.addPage(p));

        const pdfBytes = await newPdf.save();
        downloadBlob(pdfBytes, 'extracted-pages.pdf');
        status.className = 'status success';
        status.textContent = `تم استخراج ${indices.length} صفحة`;
      } catch (err) {
        status.className = 'status error';
        status.textContent = 'خطأ: ' + err.message;
      }
    });

    // 3. تدوير
    document.getElementById('btn-rotate')?.addEventListener('click', async (e) => {
      const file = document.getElementById('rotate-file').files[0];
      const deg = Number(document.getElementById('rotate-degree').value);
      const status = document.getElementById('rotate-status');

      if (!file) return status.textContent = 'اختر ملف PDF';

      status.className = 'status';
      status.textContent = 'جاري التدوير...';

      try {
        const buf = await file.arrayBuffer();
        const pdf = await PDFDocument.load(buf);
        pdf.getPages().forEach(page => {
          const current = page.getRotation().angle;
          page.setRotation(degrees(current + deg));
        });
        const pdfBytes = await pdf.save();
        downloadBlob(pdfBytes, 'rotated-document.pdf');
        status.className = 'status success';
        status.textContent = 'تم التدوير بنجاح';
      } catch (err) {
        status.className = 'status error';
        status.textContent = 'خطأ: ' + err.message;
      }
    });

    // 4. علامة مائية
    document.getElementById('btn-watermark')?.addEventListener('click', async (e) => {
      const file = document.getElementById('watermark-file').files[0];
      const text = document.getElementById('watermark-text').value.trim();
      const status = document.getElementById('watermark-status');

      if (!file) return status.textContent = 'اختر ملف PDF';
      if (!text) return status.textContent = 'أدخل نص العلامة';

      status.className = 'status';
      status.textContent = 'جاري الإضافة...';

      try {
        const buf = await file.arrayBuffer();
        const pdf = await PDFDocument.load(buf);
        const font = await pdf.embedFont('Helvetica');

        pdf.getPages().forEach(page => {
          const { width, height } = page.getSize();
          page.drawText(text, {
            x: width / 2 - 120,
            y: height / 2 - 20,
            size: 50,
            font,
            color: rgb(0.75, 0.75, 0.75),
            rotate: degrees(45),
            opacity: 0.2,
          });
        });

        const pdfBytes = await pdf.save();
        downloadBlob(pdfBytes, 'watermarked.pdf');
        status.className = 'status success';
        status.textContent = 'تمت إضافة العلامة المائية';
      } catch (err) {
        status.className = 'status error';
        status.textContent = 'خطأ: ' + err.message;
      }
    });
  </script>
</body>
</html>
